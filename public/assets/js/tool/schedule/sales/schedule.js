function getShortName(e){return e?e.trim().split(" ").pop():""}function formatDate(e){if(!e)return"";var t=new Date(e),n=t.getDate(),a=t.getMonth()+1;return(n=n<10?"0"+n:n)+"/"+(a=a<10?"0"+a:a)+"/"+t.getFullYear()}function carRenameFunction(e){return{6:"Xe Thuê",7:"Xe Tăng Cường",8:"Xe Siêu Âm"}[e]||"Xe "+e}function getCarColor(e){switch(parseInt(e)){case 1:default:return"bg-blue";case 2:return"bg-gray";case 3:return"bg-green";case 4:return"bg-red";case 5:return"bg-yellow";case 6:return"bg-purple";case 7:return"bg-orange";case 8:return"bg-teal"}}function schedule(e){jQuery(document).ready(function(t){var n="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",a=t(".csstransitions").length>0;function i(e){this.element=e,this.timeline=this.element.find(".timeline"),this.timelineItems=this.timeline.find("li"),this.timelineItemsNumber=this.timelineItems.length,this.timelineStart=r(this.timelineItems.eq(0).text()),this.timelineUnitDuration=r(this.timelineItems.eq(1).text())-r(this.timelineItems.eq(0).text()),this.eventsWrapper=this.element.find(".events"),this.eventsGroup=this.eventsWrapper.find(".events-group"),this.singleEvents=this.eventsGroup.find(".single-event"),this.eventSlotHeight=this.eventsGroup.eq(0).children(".top-info").outerHeight(),this.modal=this.element.find(".event-modal"),this.modalHeader=this.modal.find(".header"),this.modalHeaderBg=this.modal.find(".header-bg"),this.modalBody=this.modal.find(".body"),this.modalBodyBg=this.modal.find(".body-bg"),this.modalMaxWidth=800,this.modalMaxHeight=640,this.animating=!1,this.initSchedule()}a||(n="noTransition"),i.prototype.initSchedule=function(){this.scheduleReset(),this.initEvents()},i.prototype.scheduleReset=function(){var t=this.mq();"desktop"==t?(this.eventSlotHeight=this.eventsGroup.eq(0).children(".top-info").outerHeight(),this.element.addClass("js-full"),this.placeEvents(),this.element.hasClass("modal-is-open")&&this.checkEventModal(),30==e?this.eventsGroup.children("ul").css({height:"3000px"}):this.eventsGroup.children("ul").css({height:"3100px"})):"mobile"==t?(this.element.removeClass("js-full loading"),this.eventsGroup.children("ul").add(this.singleEvents).removeAttr("style"),this.eventsWrapper.children(".grid-line").remove(),this.element.hasClass("modal-is-open")&&this.checkEventModal()):"desktop"==t&&this.element.hasClass("modal-is-open")?(this.checkEventModal("desktop"),this.element.removeClass("loading")):this.element.removeClass("loading")},i.prototype.initEvents=function(){var e=this;this.singleEvents.each(function(){t(this).on("click","a",function(n){n.preventDefault(),e.animating||e.openModal(t(this))})}),t(document).off("click",".single-card-event a").on("click",".single-card-event a",function(n){n.preventDefault(),n.stopPropagation(),e.animating||e.openModal(t(this))}),this.modal.on("click",".close",function(t){t.preventDefault(),e.animating||e.closeModal(e.eventsGroup.find(".selected-event"))}),this.element.on("click",".cover-layer",function(t){!e.animating&&e.element.hasClass("modal-is-open")&&e.closeModal(e.eventsGroup.find(".selected-event"))})},i.prototype.placeEvents=function(){var e=this,n=0;this.singleEvents.each(function(){var a=r(t(this).attr("data-start")),i=r(t(this).attr("data-start")),o=0,s=20;t(this).hasClass("bg-back")?(o=5,s=36,t(this).css({left:"18px"})):t(this).css({left:"10px"}),n=a==i?60:i-a+60;var l=e.eventSlotHeight*(a-e.timelineStart)/e.timelineUnitDuration,d=e.eventSlotHeight*n/e.timelineUnitDuration;t(this).css({top:l+10+o+"px",height:d-20+"px",width:"calc(100% - "+s+"px)"})}),this.element.removeClass("loading")},i.prototype.openModal=function(e){var i=this,o=i.mq();this.animating=!0,t("body").css("overflow","hidden"),t("#calendarModal").is(":visible")?(this.isFromMulti=!0,t("#calendarModal").hide()):this.isFromMulti=!1;var s=e.closest("[data-json]");0===s.length&&(s=e.closest(".single-event"));var l=s.attr("data-json"),d={};try{l&&(d="string"==typeof l?JSON.parse(l):l)}catch(e){}var r=Array.isArray(d)?d[0]:d,m=r.car_ktv_name_1,h=r.car_ktv_name_2,v=getShortName(m),u=getShortName(h),f=v+(u?", "+u:"");this.modalHeader.find(".event-date").html(formatDate(r.ord_start_day)),this.modalHeader.find(".event-technician").html(f),this.modalHeader.find(".event-order-id").html("<b>Mã đơn hàng:</b> "+r.order_id),this.modalHeader.find(".event-unit").html("<b>Đơn vị:</b> "+r.unit_abbreviation),this.modal.attr("data-event",e.parent().attr("data-event"));var p=i.modalBody,g=(e,t)=>p.find(e).text(null!=t?t:"");g(".event-car-id").text(r.id),g(".event-order-id").text(r.order_id),g(".event-unit").text(r.unit_abbreviation),g(".event-cty-name").text(r.ord_cty_name),g(".event-address").text(r.customer_address),g(".event-other-address").text(r.customer_note),g(".event-select").text(r.ord_select),g(".event-info-contact").html((r.customer_name||"")+" ("+(r.customer_phone||"")+")"),g(".event-time").html(r.ord_time),g(".event-quantity").html(r.order_quantity),g(".event-doctor-read").html(r.ord_doctor_read),g(".event-film").html(r.ord_film),g(".event-form").html(r.ord_form),g(".event-print").html(r.ord_print),g(".event-form-print").html(r.ord_form_print),g(".event-print-result").html(r.ord_print_result),g(".event-film-sheet").html(r.ord_film_sheet),g(".event-order-note").html(r.ord_note),g(".event-ord-warning").html(r.order_warning),g(".event-deadline").html(formatDate(r.ord_deadline)),g(".event-deliver-results").html(r.ord_deliver_results),g(".event-email").html(r.ord_email),g(".event-draft").html((r.order_quantity_draft||0)+" Cas"),g(".event-noteKtv").html(r.order_note_ktv),g(".event-accountant-doctor-read").html(r.accountant_doctor_read),g(".event-accountant-35X43").html(r.accountant_35X43),g(".event-accountant-polime").html(r.accountant_polime),g(".event-accountant-8X10").html(r.accountant_8X10),g(".event-accountant-10X12").html(r.accountant_10X12),g(".event-accountant-note").html(r.accountant_note),g(".event-ord-delivery-date").html(formatDate(r.ord_delivery_date)),g(".event-order-send-result").html(r.order_send_result);var _='<span class="processed">Đã xử lý</span>';1==r.status_id?_='<span class="processing">Đang xử lý</span>':2==r.status_id?_='<span class="updated">Đã cập nhật số Cas thực tế</span>':4==r.status_id&&(_='<span class="update-acc">Đã cập nhật doanh thu</span>'),p.find(".event-status").html(_);var y=r.ord_list_file_path||"",b=r.ord_list_file||"";if(""!=y||0!=b){var x=y.split(","),w=b.split(","),M="";Array.prototype.associate||(Array.prototype.associate=function(e){var t={};return this.forEach(function(n,a){t[e[a]]=n}),t}),t.each(x.associate(w),(e,t)=>{M+='<div class="main-file"><div class="file-content"><div class="file-name">'+e+'</div><div class="file-action"><a href="https://drive.google.com/file/d/'+t+'/view"target="_blank" class="download-file"><i class="far fa-eye"></i></a></div></div></div>'}),p.find(".event-list-file").html('<div class="section-file">'+M+"</div>")}else p.find(".event-list-file").html("Không có danh sách");var C=r.ord_total_file_path||"",k=r.ord_total_file_name||"",H=r.order_detail_id||"",B=p.find(".total-file"),E=p.find(".event-total-file");if(""!==C||""!==k){B.addClass("hidden");var $=`\n                            <div class="section-file">\n                                <input type="hidden" name="path" value="${C}">\n                                <input type="hidden" name="file" value="${k}">\n                                <input type="hidden" name="id" value="${H}">\n                                <div class="main-file">\n                                    <div class="file-content">\n                                        <div class="file-name">${k}</div>\n                                        <div class="file-action">\n                                            <a href="https://drive.google.com/file/d/${C}/view" target="_blank" class="download-file"><i class="far fa-eye"></i></a>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>`;E.html($)}else E.html("");const S=new Date;S.setHours(0,0,0,0);var T=new Date(r.ord_start_day).getTime()>=S.getTime()?`<a href="${r.edit_url}" target="_blank" class="form-button button-submit rs-lookup-submit">Chỉnh sửa</a>`:"";if(p.find(".rs-overlay-change").html(T),i.element.addClass("content-loaded"),this.element.addClass("modal-is-open"),setTimeout(function(){e.parent("li").addClass("selected-event")},10),"mobile"==o)i.modal.one(n,function(){i.modal.off(n),i.animating=!1});else{var D=e.offset().top-t(window).scrollTop(),I=e.offset().left,q=t(window).width(),N=t(window).height(),A=.8*q>i.modalMaxWidth?i.modalMaxWidth:.8*q,X=.8*N>i.modalMaxHeight?i.modalMaxHeight:.8*N,G=parseInt((q-A)/2-I),W=parseInt((N-X)/2-D);i.modal.css({top:D+"px",left:I+"px",height:X+"px",width:A+"px"}),c(i.modal,"translateY("+W+"px) translateX("+G+"px)"),i.modalHeaderBg.one(n,function(){i.modalHeaderBg.off(n),i.animating=!1,i.element.addClass("animation-completed")})}a||i.modal.add(i.modalHeaderBg).trigger(n)},i.prototype.closeModal=function(e){var i=this,o=i.mq();if(this.animating=!0,i.modalBody.find(".rs-overlay-change").html(""),t("body").removeAttr("style"),this.isFromMulti&&(t("body").css("overflow","hidden"),t("#calendarModal").css("display","flex")),"mobile"==o)this.element.removeClass("modal-is-open"),this.modal.one(n,function(){i.modal.off(n),i.animating=!1,i.element.removeClass("content-loaded"),e.removeClass("selected-event")});else{var s=e.innerHeight(),l=e.innerWidth(),d=Number(i.modal.css("top").replace("px","")),r=Number(i.modal.css("left").replace("px","")),m=d;i.element.removeClass("animation-completed modal-is-open"),this.modal.css({width:l+"px",height:s+"px"}),c(i.modal,"translateX("+r+"px) translateY("+m+"px)"),c(i.modalBodyBg,"scaleX(0) scaleY(1)"),c(i.modalHeaderBg,"scaleY(1)"),this.modalHeaderBg.one(n,function(){i.modalHeaderBg.off(n),i.modal.addClass("no-transition"),setTimeout(function(){i.modal.add(i.modalHeader).add(i.modalBody).add(i.modalHeaderBg).add(i.modalBodyBg).attr("style","")},10),setTimeout(function(){i.modal.removeClass("no-transition")},20),i.animating=!1,i.element.removeClass("content-loaded"),e.removeClass("selected-event")})}a||i.modal.add(i.modalHeaderBg).trigger(n)},i.prototype.mq=function(){return window.getComputedStyle(this.element.get(0),"::before").getPropertyValue("content").replace(/["']/g,"")},i.prototype.checkEventModal=function(e){this.animating=!0;var n=this,a=this.mq();if("mobile"==a)n.modal.add(n.modalHeader).add(n.modalHeaderBg).add(n.modalBody).add(n.modalBodyBg).attr("style",""),n.modal.removeClass("no-transition"),n.animating=!1;else if("desktop"==a&&n.element.hasClass("modal-is-open")){n.modal.addClass("no-transition"),n.element.addClass("animation-completed");var i=n.eventsGroup.find(".selected-event");eventHeight=i.innerHeight(),eventWidth=i.innerWidth();var o=t(window).width(),s=t(window).height(),l=.8*o>n.modalMaxWidth?n.modalMaxWidth:.8*o,d=.8*s>n.modalMaxHeight?n.modalMaxHeight:.8*s;setTimeout(function(){n.modal.css({width:l+"px",height:d+"px",top:s/2-d/2+"px",left:o/2-l/2+"px"}),c(n.modal,"translateY(0) translateX(0)")},10),setTimeout(function(){n.modal.removeClass("no-transition"),n.animating=!1},20)}};var o=t(".cd-schedule"),s=[],l=!1;function d(){s.forEach(function(e){e.scheduleReset()}),l=!1}function r(e){var t=(e=e.replace(/ /g,"")).split("/");return 60*parseInt(t[0])}function c(e,t){e.css({"-moz-transform":t,"-webkit-transform":t,"-ms-transform":t,"-o-transform":t,transform:t})}o.length>0&&o.each(function(){s.push(new i(t(this)))}),t(window).on("resize",function(){l||(l=!0,window.requestAnimationFrame?window.requestAnimationFrame(d):setTimeout(d))}),t(window).keyup(function(e){27==e.keyCode&&s.forEach(function(e){e.closeModal(e.eventsGroup.find(".selected-event"))})})})}function openMultiModal(e){$("body").css("overflow","hidden");var t=e.getAttribute("data-json");if(t){var n=JSON.parse(t),a=document.getElementById("modalBody"),i=document.getElementById("header-date-label"),o=document.getElementById("header-headline");n.length>0&&(i.innerText=" Ngày "+formatDate(n[0].ord_start_day),o.innerText="Danh Sách Lịch "+carRenameFunction(n[0].car_name)),a.innerHTML="",n.forEach(function(e){var t=document.createElement("div"),n=getCarColor(e.car_name);t.className=`single-event single-card-event ${n} border-child`,t.setAttribute("data-start",formatDate(e.ord_start_day)),t.setAttribute("data-content","event-rowing-workout"),t.setAttribute("data-event","event-"+e.car_name),t.setAttribute("data-json",JSON.stringify(e));var i=getShortName(e.car_ktv_name_1),o=getShortName(e.car_ktv_name_2),s=i+(o?", "+o:"");t.innerHTML=`\n            <div class="notification-icon-block">\n                ${"Có"==e.order_warning?'<div class="order-warning"><i class="fa fa-exclamation-triangle"></i></div>':""}\n                ${1==e.order_updated?'<div class="order-status"><i class="fas fa-check-circle"></i></div>':""}\n            </div>\n            <a href="javascript:;" style="padding: 10px; display: block;">\n                <div class="event-title">\n                    <div class="sub-title">\n                        <span class="sub-title-date"><b>Ngày:</b>\n                            ${formatDate(e.ord_start_day)}\n                        </span>\n                        <p class="line">-</p>\n                        <span class="sub-title-technician"><b>KTV:</b>\n                            ${s}\n                        </span>\n                    </div>\n                    <span class="event-name-unit">\n                        <b>Mã đơn hàng:</b> ${e.order_id}\n                    </span>\n                    <p class="event-name-unit">\n                        <b>Đơn vị:</b> ${e.unit_abbreviation}\n                    </p>\n                </div>\n            </a>\n        `,a.appendChild(t)}),document.getElementById("calendarModal").style.display="flex"}}function closeMultiModal(){$("body").removeAttr("style"),document.getElementById("calendarModal").style.display="none"}schedule(day),window.onclick=function(e){e.target==document.getElementById("calendarModal")&&closeMultiModal()},$(".select-month").on("change",function(){var e=$(this).val(),t=$(".select-year").val();$(".loader-over").fadeIn(),$.ajax({url:url_select_sales,method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),year:t,month:e},success:function(e){schedule(e.day),$(".schedule").html(e.html),$(".loader-over").fadeOut()},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".loader-over").fadeOut()}})}),$(".select-year").on("change",function(){$(".define-month").prop("selected",!0)});