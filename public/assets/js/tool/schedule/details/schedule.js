const currentTime=JSON.parse(localStorage.getItem("currentTime"))||[],currentLocation=window.location.pathname;function getValues(){return[{name:"order_quantity_details",value:$(".order-quantity").val()},{name:"accountant_doctor_read",value:$(".accountant-doctor-read").val()},{name:"accountant_35X43",value:$(".accountant-35X43").val()},{name:"accountant_polime",value:$(".accountant-polime").val()},{name:"accountant_8X10",value:$(".accountant-8X10").val()},{name:"accountant_10X12",value:$(".accountant-10X12").val()},{name:"accountant_note",value:$(".accountant-note").val()},{name:"ord_delivery_date",value:$(".ord-delivery-date").val()},{name:"order_send_result",value:$(".order-send-result:checked").map(function(){return $(this).val()}).get()},{name:"ord_total_file_name",value:$("input[name=ord_total_file_name]").val()}]}function pushCurrentTime(e,t){var a={month:e,year:t};localStorage.setItem("currentTime",JSON.stringify(a))}function getShortName(e){return e?e.trim().split(" ").pop():""}function formatDate(e){if(!e)return"";var t=new Date(e),a=t.getDate(),n=t.getMonth()+1;return(a=a<10?"0"+a:a)+"/"+(n=n<10?"0"+n:n)+"/"+t.getFullYear()}function carRenameFunction(e){return{6:"Xe Thuê",7:"Xe Tăng Cường",8:"Xe Siêu Âm"}[e]||"Xe "+e}function getCarColor(e){switch(parseInt(e)){case 1:default:return"bg-blue";case 2:return"bg-gray";case 3:return"bg-green";case 4:return"bg-red";case 5:return"bg-yellow";case 6:return"bg-purple";case 7:return"bg-orange";case 8:return"bg-teal"}}function schedule(e){jQuery(document).ready(function(t){var a="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",n=t(".csstransitions").length>0;function o(e){this.element=e,this.timeline=this.element.find(".timeline"),this.timelineItems=this.timeline.find("li"),this.timelineItemsNumber=this.timelineItems.length,this.timelineStart=d(this.timelineItems.eq(0).text()),this.timelineUnitDuration=d(this.timelineItems.eq(1).text())-d(this.timelineItems.eq(0).text()),this.eventsWrapper=this.element.find(".events"),this.eventsGroup=this.eventsWrapper.find(".events-group"),this.singleEvents=this.eventsGroup.find(".single-event"),this.eventSlotHeight=this.eventsGroup.eq(0).children(".top-info").outerHeight(),this.modal=this.element.find(".event-modal"),this.modalHeader=this.modal.find(".header"),this.modalHeaderBg=this.modal.find(".header-bg"),this.modalBody=this.modal.find(".body"),this.modalBodyBg=this.modal.find(".body-bg"),this.modalMaxWidth=800,this.modalMaxHeight=640,this.animating=!1,this.initSchedule()}n||(a="noTransition"),o.prototype.initSchedule=function(){this.scheduleReset(),this.initEvents()},o.prototype.scheduleReset=function(){var t=this.mq();"desktop"==t?(this.eventSlotHeight=this.eventsGroup.eq(0).children(".top-info").outerHeight(),this.element.addClass("js-full"),this.placeEvents(),this.element.hasClass("modal-is-open")&&this.checkEventModal(),30==e?this.eventsGroup.children("ul").css({height:"3000px"}):this.eventsGroup.children("ul").css({height:"3100px"})):"mobile"==t?(this.element.removeClass("js-full loading"),this.eventsGroup.children("ul").add(this.singleEvents).removeAttr("style"),this.eventsWrapper.children(".grid-line").remove(),this.element.hasClass("modal-is-open")&&this.checkEventModal()):"desktop"==t&&this.element.hasClass("modal-is-open")?(this.checkEventModal("desktop"),this.element.removeClass("loading")):this.element.removeClass("loading")},o.prototype.initEvents=function(){var e=this;this.singleEvents.each(function(){t(this).on("click","a",function(a){a.preventDefault(),e.animating||e.openModal(t(this))})}),t(document).off("click",".single-card-event a").on("click",".single-card-event a",function(a){a.preventDefault(),a.stopPropagation(),e.animating||e.openModal(t(this))}),this.modal.on("click",".close",function(t){t.preventDefault(),e.animating||e.closeModal(e.eventsGroup.find(".selected-event"))}),this.element.on("click",".cover-layer",function(t){!e.animating&&e.element.hasClass("modal-is-open")&&e.closeModal(e.eventsGroup.find(".selected-event"))})},o.prototype.placeEvents=function(){var e=this,a=0;this.singleEvents.each(function(){var n=d(t(this).attr("data-start")),o=d(t(this).attr("data-start")),s=0,i=20;t(this).hasClass("bg-back")?(s=5,i=36,t(this).css({left:"18px"})):t(this).css({left:"10px"}),a=n==o?60:o-n+60;var l=e.eventSlotHeight*(n-e.timelineStart)/e.timelineUnitDuration,r=e.eventSlotHeight*a/e.timelineUnitDuration;t(this).css({top:l+10+s+"px",height:r-20+"px",width:"calc(100% - "+i+"px)"})}),this.element.removeClass("loading")},o.prototype.openModal=function(e){var o=this,s=o.mq();this.animating=!0,t("body").css("overflow","hidden"),t("#calendarModal").is(":visible")?(this.isFromMulti=!0,t("#calendarModal").hide()):this.isFromMulti=!1;var i=e.closest("[data-json]");0===i.length&&(i=e.closest(".single-event"));var l=i.attr("data-json"),r={};try{l&&(r="string"==typeof l?JSON.parse(l):l)}catch(e){}var d=Array.isArray(r)?r[0]:r,m=d.car_ktv_name_1,u=d.car_ktv_name_2,h=getShortName(m),v=getShortName(u),f=h+(v?", "+v:"");this.modalHeader.find(".event-date").html(formatDate(d.ord_start_day)),this.modalHeader.find(".event-technician").html(f),this.modalHeader.find(".event-order-id").html("<b>Mã đơn hàng:</b> "+d.order_id),this.modalHeader.find(".event-unit").html("<b>Đơn vị:</b> "+d.unit_abbreviation),this.modal.attr("data-event",e.parent().attr("data-event"));var p=o.modalBody,g=(e,t)=>p.find(e).text(null!=t?t:"");g(".event-car-id").text(d.id),g(".event-order-id").text(d.order_id),g(".event-unit").text(d.unit_abbreviation),g(".event-cty-name").text(d.ord_cty_name),g(".event-address").text(d.customer_address),g(".event-other-address").text(d.customer_note),g(".event-select").text(d.ord_select),g(".event-info-contact").html((d.customer_name||"")+" ("+(d.customer_phone||"")+")"),g(".event-time").html(d.ord_time),g(".event-quantity").html(d.order_quantity),g(".event-doctor-read").html(d.ord_doctor_read),g(".event-film").html(d.ord_film),g(".event-form").html(d.ord_form),g(".event-print").html(d.ord_print),g(".event-form-print").html(d.ord_form_print),g(".event-print-result").html(d.ord_print_result),g(".event-film-sheet").html(d.ord_film_sheet),g(".event-order-note").html(d.ord_note),g(".event-ord-warning").html(d.order_warning),g(".event-deadline").html(formatDate(d.ord_deadline)),g(".event-deliver-results").html(d.ord_deliver_results),g(".event-email").html(d.ord_email),g(".event-draft").html((d.order_quantity_draft||0)+" Cas"),g(".event-noteKtv").html(d.order_note_ktv);var _='<span class="processed">Đã xử lý</span>';1==d.status_id?_='<span class="processing">Đang xử lý</span>':2==d.status_id?_='<span class="updated">Đã cập nhật số Cas thực tế</span>':4==d.status_id&&(_='<span class="update-acc">Đã cập nhật doanh thu</span>'),p.find(".event-status").html(_);var y=d.ord_list_file_path||"",b=d.ord_list_file||"";if(""!=y||0!=b){var $=y.split(","),x=b.split(","),w="";Array.prototype.associate||(Array.prototype.associate=function(e){var t={};return this.forEach(function(a,n){t[e[n]]=a}),t}),t.each($.associate(x),(e,t)=>{w+='<div class="main-file"><div class="file-content"><div class="file-name">'+e+'</div><div class="file-action"><a href="https://drive.google.com/file/d/'+t+'/view"target="_blank" class="download-file"><i class="far fa-eye"></i></a></div></div></div>'}),p.find(".event-list-file").html('<div class="section-file">'+w+"</div>")}else p.find(".event-list-file").html("Không có danh sách");var C=(e,t)=>{var a=p.find(e);a.val(t),t?a.addClass("form-textbox-entered"):a.removeClass("form-textbox-entered")};C(".order-quantity",d.order_quantity),C(".accountant-35X43",d.accountant_35X43),C(".accountant-polime",d.accountant_polime),C(".accountant-8X10",d.accountant_8X10),C(".accountant-10X12",d.accountant_10X12),C(".accountant-note",d.accountant_note),C(".ord-delivery-date",d.ord_delivery_date);var k={"Nhân":".doctor-N",Trung:".doctor-T",Giang:".doctor-G","Ân":".doctor-A"}[d.accountant_doctor_read]||".doctor-empty";p.find(".accountant-doctor-read option").prop("selected",!1),p.find(k).prop("selected",!0),p.find(".block-order-send-result").html(function(){var e="",t=(d.order_send_result||"").split(","),a=t.includes("Gmail"),n=t.includes("Zalo"),o=(e,t)=>`<div class="form-checkbox"><input type="checkbox" id="result-${e}" name="order_send_result" class="form-checkbox-input order-send-result" value="${e}" ${t?"checked":""}><label for="result-${e}" class="form-label">${e}</label></div>`;return e+=o("Gmail",a),e+=o("Zalo",n)});var M=3==d.status_id;p.find(".order-quantity, .accountant-doctor-read, .accountant-35X43, .accountant-polime, .accountant-8X10, .accountant-10X12, .accountant-note, .ord-delivery-date, .order-send-result, .submit-quantity-details").attr("disabled",M),M?p.find(".submit-quantity-details").addClass("hidden"):p.find(".submit-quantity-details").removeClass("hidden");var S=d.ord_total_file_path||"",T=d.ord_total_file_name||"",H=d.order_detail_id||"",E=p.find(".total-file"),B=p.find(".event-total-file");if(""!==S||""!==T){E.addClass("hidden");var q=`\n                                <div class="section-file">\n                                    <input type="hidden" name="path" value="${S}">\n                                    <input type="hidden" name="file" value="${T}">\n                                    <input type="hidden" name="id" value="${H}">\n                                    <div class="main-file">\n                                        <div class="file-content">\n                                            <div class="file-name">${T}</div>\n                                            <div class="file-action">\n                                                <a href="https://drive.google.com/file/d/${S}/view" target="_blank" class="download-file"><i class="far fa-eye"></i></a>\n                                                ${M?"":'<button class="delete-file del-total-file" type="button"><i class="fas fa-times"></i></button>'}\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>`;B.html(q)}else M?E.addClass("hidden"):E.removeClass("hidden"),B.html("");if(o.element.addClass("content-loaded"),this.element.addClass("modal-is-open"),setTimeout(function(){e.parent("li").addClass("selected-event")},10),"mobile"==s)o.modal.one(a,function(){o.modal.off(a),o.animating=!1});else{var N=e.offset().top-t(window).scrollTop(),I=e.offset().left,O=t(window).width(),X=t(window).height(),A=.8*O>o.modalMaxWidth?o.modalMaxWidth:.8*O,D=.8*X>o.modalMaxHeight?o.modalMaxHeight:.8*X,G=parseInt((O-A)/2-I),j=parseInt((X-D)/2-N);o.modal.css({top:N+"px",left:I+"px",height:D+"px",width:A+"px"}),c(o.modal,"translateY("+j+"px) translateX("+G+"px)"),o.modalHeaderBg.one(a,function(){o.modalHeaderBg.off(a),o.animating=!1,o.element.addClass("animation-completed")})}n||o.modal.add(o.modalHeaderBg).trigger(a)},o.prototype.closeModal=function(e){var o=this,s=o.mq();if(this.animating=!0,t("body").removeAttr("style"),this.isFromMulti&&(t("body").css("overflow","hidden"),t("#calendarModal").css("display","flex")),"mobile"==s)this.element.removeClass("modal-is-open"),this.modal.one(a,function(){o.modal.off(a),o.animating=!1,o.element.removeClass("content-loaded"),e.removeClass("selected-event")});else{var i=e.innerHeight(),l=e.innerWidth(),r=Number(o.modal.css("top").replace("px","")),d=Number(o.modal.css("left").replace("px","")),m=r;o.element.removeClass("animation-completed modal-is-open"),this.modal.css({width:l+"px",height:i+"px"}),c(o.modal,"translateX("+d+"px) translateY("+m+"px)"),c(o.modalBodyBg,"scaleX(0) scaleY(1)"),c(o.modalHeaderBg,"scaleY(1)"),this.modalHeaderBg.one(a,function(){o.modalHeaderBg.off(a),o.modal.addClass("no-transition"),setTimeout(function(){o.modal.add(o.modalHeader).add(o.modalBody).add(o.modalHeaderBg).add(o.modalBodyBg).attr("style","")},10),setTimeout(function(){o.modal.removeClass("no-transition")},20),o.animating=!1,o.element.removeClass("content-loaded"),e.removeClass("selected-event")})}n||o.modal.add(o.modalHeaderBg).trigger(a)},o.prototype.mq=function(){return window.getComputedStyle(this.element.get(0),"::before").getPropertyValue("content").replace(/["']/g,"")},o.prototype.checkEventModal=function(e){this.animating=!0;var a=this,n=this.mq();if("mobile"==n)a.modal.add(a.modalHeader).add(a.modalHeaderBg).add(a.modalBody).add(a.modalBodyBg).attr("style",""),a.modal.removeClass("no-transition"),a.animating=!1;else if("desktop"==n&&a.element.hasClass("modal-is-open")){a.modal.addClass("no-transition"),a.element.addClass("animation-completed");var o=a.eventsGroup.find(".selected-event");eventHeight=o.innerHeight(),eventWidth=o.innerWidth();var s=t(window).width(),i=t(window).height(),l=.8*s>a.modalMaxWidth?a.modalMaxWidth:.8*s,r=.8*i>a.modalMaxHeight?a.modalMaxHeight:.8*i;setTimeout(function(){a.modal.css({width:l+"px",height:r+"px",top:i/2-r/2+"px",left:s/2-l/2+"px"}),c(a.modal,"translateY(0) translateX(0)")},10),setTimeout(function(){a.modal.removeClass("no-transition"),a.animating=!1},20)}};var s=t(".cd-schedule"),i=[],l=!1;function r(){i.forEach(function(e){e.scheduleReset()}),l=!1}function d(e){var t=(e=e.replace(/ /g,"")).split("/");return 60*parseInt(t[0])}function c(e,t){e.css({"-moz-transform":t,"-webkit-transform":t,"-ms-transform":t,"-o-transform":t,transform:t})}s.length>0&&s.each(function(){i.push(new o(t(this)))}),t(window).on("resize",function(){l||(l=!0,window.requestAnimationFrame?window.requestAnimationFrame(r):setTimeout(r))}),t(window).keyup(function(e){27==e.keyCode&&i.forEach(function(e){e.closeModal(e.eventsGroup.find(".selected-event"))})})})}function openMultiModal(e){$("body").css("overflow","hidden");var t=e.getAttribute("data-json");if(t){var a=JSON.parse(t),n=document.getElementById("modalBody"),o=document.getElementById("header-date-label"),s=document.getElementById("header-headline");a.length>0&&(o.innerText=" Ngày "+formatDate(a[0].ord_start_day),s.innerText="Danh Sách Lịch "+carRenameFunction(a[0].car_name)),n.innerHTML="",a.forEach(function(e){var t=document.createElement("div"),a=getCarColor(e.car_name);t.className=`single-event single-card-event ${a} border-child`,t.setAttribute("data-start",formatDate(e.ord_start_day)),t.setAttribute("data-content","event-rowing-workout"),t.setAttribute("data-event","event-"+e.car_name),t.setAttribute("data-json",JSON.stringify(e));var o=getShortName(e.car_ktv_name_1),s=getShortName(e.car_ktv_name_2),i=o+(s?", "+s:"");t.innerHTML=`\n                <div class="notification-icon-block">\n                    ${"Có"==e.order_warning?'<div class="order-warning"><i class="fa fa-exclamation-triangle"></i></div>':""}\n                    ${1==e.order_updated?'<div class="order-status"><i class="fas fa-check-circle"></i></div>':""}\n                </div>\n                <a href="javascript:;" style="padding: 10px; display: block;">\n                    <div class="event-title">\n                        <div class="sub-title">\n                            <span class="sub-title-date"><b>Ngày:</b>\n                                ${formatDate(e.ord_start_day)}\n                            </span>\n                            <p class="line">-</p>\n                            <span class="sub-title-technician"><b>KTV:</b>\n                                ${i}\n                            </span>\n                        </div>\n                        <span class="event-name-unit">\n                            <b>Mã đơn hàng:</b> ${e.order_id}\n                        </span>\n                        <p class="event-name-unit">\n                            <b>Đơn vị:</b> ${e.unit_abbreviation}\n                        </p>\n                    </div>\n                </a>\n            `,n.appendChild(t)}),document.getElementById("calendarModal").style.display="flex"}}function closeMultiModal(){$("body").removeAttr("style"),document.getElementById("calendarModal").style.display="none"}$.ajax({url:url_get_schedule,method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),currentTime:currentTime},success:function(e){$(".schedule-render").html(e.html),schedule(e.day)}}),window.onclick=function(e){e.target==document.getElementById("calendarModal")&&closeMultiModal()},$(document).on("change",".select-month",function(){var e=$(this).val(),t=$(".select-year").val();$(".schedule-search").removeClass("search-show").val(""),$(".btn-search").html('<button class="btn-schedule-search"><i class="fas fa-search"></i></button>'),$(".search-results").removeClass("search-results-show").html(""),$(".loader-over").fadeIn(),$.ajax({url:url_select_details,method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),year:t,month:e},success:function(a){pushCurrentTime(e,t),schedule(a.day),$(".schedule").html(a.html),$(".loader-over").fadeOut()},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".loader-over").fadeOut()}})}),$(document).on("click",".btn-schedule-search",function(){$("input[name=search-keywords]").focus(),$(".schedule-search").addClass("search-show"),$(".btn-search").html('<button class="btn-close-search"><i class="fas fa-times"></i></button>'),$(".search-results").addClass("search-results-show")}),$(document).on("click",".btn-close-search",function(){var e=$(".select-month").val(),t=$(".select-year").val();$(".schedule-search").removeClass("search-show").val(""),$(".btn-search").html('<button class="btn-schedule-search"><i class="fas fa-search"></i></button>'),$(".search-results").removeClass("search-results-show").html(""),$(".loader-over").fadeIn(),$.ajax({url:url_select_details,method:"POST",data:{_token:$('meta[name="csrf-token"]').attr("content"),year:t,month:e},success:function(e){schedule(e.day),$(".schedule").html(e.html),$(".loader-over").fadeOut()},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".loader-over").fadeOut()}})}),$(document).on("keyup",".schedule-search",function(){var e=$(this).val(),t=JSON.parse(localStorage.getItem("currentTime"))||[];""!=e?$.ajax({url:url_search_suggest,method:"POST",data:{currentTime:t,query:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){$(".search-results").addClass("search-results-show").html(e.html)},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".loader-over").fadeOut()}}):$(".search-results").removeClass("search-results-show").html("")}),$(document).on("click",".li_search",function(){var e=$(this).text(),t=JSON.parse(localStorage.getItem("currentTime"))||[];$(".loader-over").fadeIn(),$(".search-results").removeClass("search-results-show").html(""),$(".schedule-search").val(e),$.ajax({url:url_schedule_search,method:"POST",data:{currentTime:t,param:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){schedule(e.day),$(".schedule").html(e.html),$(".loader-over").fadeOut()},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".loader-over").fadeOut()}})}),$(document).on("change",".select-year",function(){$(".define-month").prop("selected",!0)}),$(document).on("click",".submit-quantity-details",function(){var e=getValues();e.push({name:"id",value:$(".event-info").find(".event-order-id").text()},{name:"_token",value:$('meta[name="csrf-token"]').attr("content")}),$(".loader-over").fadeIn(),$.ajax({url:url_update_details,method:"POST",data:e,success:function(){$(".event-modal").fadeOut(),$(".cover-layer").css({opacity:"0"}),$(".loader-over").fadeOut(),successMsg("Bạn đã cập nhật số Cas chụp thành công"),setTimeout(function(){location.reload()},1e3)},error:function(e){popupNotificationSessionExpired()},complete:function(){$(".event-modal").fadeOut(),$(".cover-layer").css({opacity:"0"}),$(".loader-over").fadeOut()}})});