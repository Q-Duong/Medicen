$(document).ready(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":profitConfig.csrf_token}});let t=!1,i={total_revenue:0,total_cost:0,net_profit:0,profit_margin:0};function e(t){return new Intl.NumberFormat("vi-VN").format(Math.round(t))}function a(t){let i=$(t).val();return i&&(i=i.toString().replace(/,/g,"")),i?parseFloat(i):0}function _(){let t=a("#inp_so_ngay"),_=a("#inp_so_km"),n=a("#inp_so_nguoi"),o=a("#inp_so_dem"),c=a("#thu_xq_sl"),l=a("#thu_cstl_sl"),h=c+2*l;$("#chi_baophim_sl").val(c),$("#chi_phim16_sl").val(c),$("#chi_phim810_sl").val(l),$("#chi_bsdoc_sl").val(h),$("#chi_bpkq_sl").val(h),$("#chi_taixe_sl").val(t),$("#chi_ktv_sl").val(t),$("#chi_ks_sl").val(o),$("#chi_dem_sl").val(o);let s=a("#thu_xq_gia")*c,u=a("#thu_cstl_gia")*l,r=a("#thu_phuthu_gia")*a("#thu_phuthu_sl"),d=a("#thu_bs_gia")*a("#thu_bs_sl"),p=s+u+r+d;$("#thu_xq_total").text(e(s)),$("#thu_cstl_total").text(e(u)),$("#thu_phuthu_total").text(e(r)),$("#thu_bs_total").text(e(d)),$("#tong_thu").text(e(p));let m=a("#chi_baophim_gia")*a("#chi_baophim_sl"),g=a("#chi_phim16_gia")*a("#chi_phim16_sl"),f=a("#chi_phim810_gia")*a("#chi_phim810_sl"),x=a("#chi_phim1012_gia")*a("#chi_phim1012_sl"),v=a("#chi_chietkhau_gia")*a("#chi_chietkhau_sl");$("#chi_baophim_total").text(e(m)),$("#chi_phim16_total").text(e(g)),$("#chi_phim810_total").text(e(f)),$("#chi_phim1012_total").text(e(x)),$("#chi_chietkhau_total").text(e(v));let b=a("#chi_bsdoc_gia")*h,k=a("#chi_bstructiep_gia")*a("#chi_bstructiep_sl"),S=a("#chi_bpkq_gia")*h,w=a("#chi_phucap_xa_gia")*a("#chi_phucap_xa_sl")*n,C=a("#chi_taixe_gia")*t,y=a("#chi_ktv_gia_ca")*h+a("#chi_ktv_gia_ngay")*t,T=a("#chi_thue_tx_gia")*a("#chi_thue_tx_sl"),L=a("#chi_thue_ktv_gia")*a("#chi_thue_ktv_sl");$("#chi_bsdoc_total").text(e(b)),$("#chi_bstructiep_total").text(e(k)),$("#chi_taixe_total").text(e(C)),$("#chi_bpkq_total").text(e(S)),$("#chi_ktv_total").text(e(y)),$("#chi_phucap_xa_total").text(e(w)),$("#chi_thue_tx_total").text(e(T)),$("#chi_thue_ktv_total").text(e(L));let q=p*(a("#chi_quanly_phantram")/100),B=a("#chi_dau_dinhmuc"),F=B>0?_/B*a("#chi_dau_gia"):0,N=a("#chi_dau_phatsinh_gia")*a("#chi_dau_phatsinh_sl"),D=a("#chi_cauduong_gia")*a("#chi_cauduong_sl"),E=a("#chi_dangkiem_gia")*a("#chi_dangkiem_sl"),j=a("#chi_ks_gia")*a("#chi_ks_sl"),M=a("#chi_dem_gia")*a("#chi_dem_sl")*n,O=a("#chi_vat_phantram")/100,K=p/(1+O)*O;$("#chi_quanly_total").text(e(q)),$("#chi_dau_total").text(e(F)),$("#chi_dau_phatsinh_total").text(e(N)),$("#chi_cauduong_total").text(e(D)),$("#chi_dangkiem_total").text(e(E)),$("#chi_ks_total").text(e(j)),$("#chi_dem_total").text(e(M)),$("#chi_vat_total").text(e(K));let U=m+g+f+x+v+b+k+C+T+y+L+S+w+q+F+N+D+E+j+M+K;$("#tong_chi").text(e(U));let V=p-U;$("#loi_nhuan").text(e(V)),V<0?$("#loi_nhuan").addClass("text-danger").removeClass("text-success"):$("#loi_nhuan").addClass("text-success").removeClass("text-danger");let A=p>0?V/p*100:0;$("#ty_suat").text(A.toFixed(2)+"%"),i.total_revenue=p,i.total_cost=U,i.net_profit=V,i.profit_margin=A.toFixed(2)}$("body").on("input",".number-only",function(){let t=$(this).val(),i=t.replace(/[^0-9.]/g,"");(i.match(/\./g)||[]).length>1&&(i=i.replace(/\.+$/,"")),t!==i&&$(this).val(i)}),$("#profitForm").on("input change keyup","input, select, textarea",function(){_(),!1===t&&$("#btnSave").fadeIn()}),$("#unit_id, #comments, #inp_so_ngay, #inp_so_km, #inp_so_dem, #inp_so_nguoi").on("input change",function(){_(),t||$("#btnSave").fadeIn()}),_(),$("#btnSave").click(function(){let t=$("#unit_id").val();if(!t)return void Swal.fire("Lỗi","Chưa chọn Đơn vị!","error");let e={};$("input, textarea, select").each(function(){let t=$(this).attr("id");t&&(e[t]=$(this).val())}),$(this).prop("disabled",!0),$("#btnText").text("ĐANG LƯU..."),$("#btnSpinner").show(),$.ajax({url:profitConfig.url_save,method:"POST",data:{unit_id:t,comments:$("#comments").val(),total_revenue:i.total_revenue,total_cost:i.total_cost,net_profit:i.net_profit,profit_margin:i.profit_margin,input_data:e},success:function(){Swal.fire("Thành công","Đã lưu báo cáo!","success").then(()=>{location.reload()})},error:function(){Swal.fire("Lỗi","Có lỗi khi lưu!","error"),$("#btnSave").prop("disabled",!1),$("#btnText").text("LƯU KẾT QUẢ"),$("#btnSpinner").hide()}})}),$(".btn-load-report").click(function(){let i=$(this).data("id"),e=$(this),a=e.text();e.text("Loading...").prop("disabled",!0),t=!0,$("#btnSave").hide();let n=profitConfig.url_load.replace(":id",i);$.ajax({url:n,method:"GET",success:function(i){i.input_data&&$.each(i.input_data,function(t,i){"unit_id"!==t&&$("#"+t).val(i)}),i.unit_id&&$("#unit_id").val(String(i.unit_id)).change(),$("#comments").val(i.comments),_();let e=$("#unit_id option:selected").text(),a=new Date(i.created_at),n=a.toLocaleDateString("vi-VN")+" "+a.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});$("#viewModeTitle").text(`${e} (Ngày: ${n})`),$("#viewModeAlert").slideDown(),$("html, body").animate({scrollTop:0},"fast"),setTimeout(function(){t=!1},200)},error:function(){Swal.fire("Lỗi","Không tải được dữ liệu","error"),t=!1,$("#btnSave").show()},complete:function(){e.text(a).prop("disabled",!1)}})}),$("#btnExitViewMode").click(function(){$("#viewModeAlert").slideUp(),$("#profitForm")[0].reset(),$("#unit_name").val("").change(),$("#comments").val(""),$("#inp_so_ngay").val(0),$("#inp_so_dem").val(0),$("#inp_so_km").val(0),$("#inp_so_nguoi").val(0),_(),$("#btnSave").show(),t=!1,Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3,icon:"info",title:"Đã trở về chế độ nhập mới"})}),$(document).on("click",".btn-approve",function(){let t=$(this);Swal.fire({title:"Duyệt báo cáo?",icon:"question",showCancelButton:!0,confirmButtonText:"Duyệt",confirmButtonColor:"#198754"}).then(i=>{i.isConfirmed&&$.ajax({url:profitConfig.url_approve.replace(":id",t.data("id")),method:"POST",success:function(){Swal.fire("Đã duyệt!","","success"),$("#status-cell-"+t.data("id")).html('<span class="badge bg-success">Đã duyệt</span>'),t.fadeOut()},error:function(){Swal.fire("Lỗi","Không thể duyệt","error")}})})}),$(".btn-delete-report").click(function(){let t=$(this).data("id");Swal.fire({title:"Xóa bản ghi?",showCancelButton:!0,confirmButtonText:"Xóa",confirmButtonColor:"#d33"}).then(i=>{i.isConfirmed&&$.ajax({url:profitConfig.url_delete.replace(":id",t),method:"DELETE",success:function(){$("#row-"+t).fadeOut(),Swal.fire("Đã xóa","","success")}})})})});