var typingTimer,doneTypingInterval=600,nextPageUrl=null,isLoading=!1;const STORAGE_KEY="accountant_filter_state";function formatCurrency(t){return null===t||""===t||isNaN(t)?t:new Intl.NumberFormat("vi-VN").format(t)}const parseNumber=t=>t&&parseInt(t.toString().replace(/\D/g,""))||0,formatInputOnKeyup=t=>{let e=parseNumber(t.val());t.val(new Intl.NumberFormat("vi-VN").format(e))},getRowId=t=>{let e=t.closest("tr").data("id");if(e)return e;let a=t.attr("name");if(a){let t=a.split("_");return t[t.length-1]}return null};function toggleApplyButton(t){let e=t.find(".filter-checkbox:checked").length,a=t.closest(".dropdown-menu").find(".btn-apply-filter");0===e?a.prop("disabled",!0):a.prop("disabled",!1)}function formatDate(t){if(!t)return"";try{let e=t.split("-");return 3===e.length?`${e[2]}/${e[1]}/${e[0]}`:t}catch(e){return t}}function formatCarName(t){if(!t)return"";const e={6:"Xe Thuê",7:"Xe Tăng Cường",8:"Siêu Âm"};return e.hasOwnProperty(t)?e[t]:t}function formatAccountantStatus(t){return 0==t?"Chưa thanh toán":1==t?"Đã thanh toán":t}function formatOrderStatus(t){switch(parseInt(t)){case 0:return'<span class="badge badge-primary text-white" style="background-color: #27c24c">Đơn hàng mới</span>';case 1:return'<span class="badge badge-primary text-white" style="background-color: #FCB322">Đang xử lý</span>';case 2:return'<span class="badge badge-primary text-white" style="background-color: #c037df">Đã cập nhật số Cas thực tế</span>';case 3:return'<span class="badge badge-primary text-white" style="background-color: #007bff">Đã xử lý</span>';case 4:return'<span class="badge badge-primary text-white" style="background-color: #00d0e3">Đã cập nhật doanh thu</span>';default:return'<span class="badge badge-secondary">Chưa xác định</span>'}}function getListAccountant(t=!1){if(!nextPageUrl&&t)return;isLoading=!0;let e=$(".tbody-content tr").length,a=getValuesFilterObj();a.current_count=e;let n=t?nextPageUrl:url_get_accountant;$.ajax({url:n,method:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},cache:!1,data:a,beforeSend:function(){}}).done(function(e){t?$(".tbody-content").append(e.html):$(".tbody-content").html(e.html),void 0!==e.totals&&updateTotalsUI(e.totals),nextPageUrl=e.next_page_url,e.html}).fail(function(t,e,a){popupNotificationSessionExpired()}).complete(function(){isLoading=!1})}function updateTotalsUI(t){$("#total-price").text(formatCurrency(t.totalPrice)),$("#total-owe").text(formatCurrency(t.totalOwe)),$("#total-amount-paid").text(formatCurrency(t.totalAmountPaid)),$("#total-quantity").text(formatCurrency(t.totalQuantity)),$("#total-discount").text(formatCurrency(t.totalDiscount)),$("#total-35").text(t.total35),$("#total-polime").text(t.totalPolime),$("#total-8").text(t.total8),$("#total-10").text(t.total10),$("#total-pack").text(t.totalPack)}function getValuesFilterObj(){let t={};return $(".year-filter, .type-filter").each(function(){t[$(this).attr("name")]=$(this).val()}),$(".dropdown-list-container").each(function(){let e=$(this).data("field"),a=$(this).data("saved-values");a&&Array.isArray(a)&&(t[e]=a)}),t}function saveFilterState(){let t=getValuesFilterObj();localStorage.setItem("accountant_filter_state",JSON.stringify(t))}function restoreFilterState(){let t=localStorage.getItem("accountant_filter_state");if(!t)return;let e=JSON.parse(t);for(const[t,a]of Object.entries(e)){let e=$(`[name="${t}"]`);e.length&&e.val(a);let n=$(`.dropdown-list-container[data-field="${t}"]`);if(n.length&&Array.isArray(a)){n.data("saved-values",a);let t=n.closest(".dropdown").find(".dropdown-toggle");t.find(".selected-text").html(`(${a.length}) <span class="caret"></span>`),t.addClass("btn-info")}}}function getValuesRow(t){return $(`tr[data-id="${t}"]`).find(":input").serializeArray()}function successMsg(t){alert(t)}$(document).ready(function(){restoreFilterState(),getListAccountant(),$(document).on("keyup",".calc-inputs",function(){formatInputOnKeyup($(this))}),$(document).on("click",".excel-dropdown",function(t){t.stopPropagation()}),$(document).on("change",".check-all",function(){let t=$(this).is(":checked"),e=$(this).closest(".dropdown-menu").find(".dropdown-list-container");e.find(".filter-checkbox").prop("checked",t),toggleApplyButton(e)}),$(document).on("change",".filter-checkbox",function(){let t=$(this).closest(".dropdown-list-container"),e=t.find(".filter-checkbox").length,a=t.find(".filter-checkbox:checked").length,n=t.closest(".dropdown-menu").find(".check-all");a===e?n.prop("checked",!0):n.prop("checked",!1),toggleApplyButton(t)}),$(document).on("keyup input",".search-in-dropdown",function(){let t=$(this).val().toLowerCase(),e=$(this).closest(".dropdown-menu"),a=e.find(".dropdown-list-container"),n=e.find(".check-all"),o=n.closest("div, label"),r=a.find(".dropdown-item-checkbox");r.each(function(){let e=$(this).text().toLowerCase();$(this).toggle(e.indexOf(t)>-1)});let l=r.filter(":visible"),c=l.length;if(a.find(".empty-search-msg").remove(),0===c)o.hide(),a.append('<div class="empty-search-msg text-center text-muted p-2">No items match your search.</div>'),n.prop("checked",!1);else{o.show();let t=l.find(".filter-checkbox:checked").length;c>0&&c===t?n.prop("checked",!0):n.prop("checked",!1)}toggleApplyButton(a)}),$(document).on("shown.bs.dropdown",".dropdown",function(){let t=$(this).find(".dropdown-list-container"),e=t.data("field"),a=t.closest(".dropdown-menu"),n=a.find(".check-all"),o=a.find(".btn-apply-filter"),r=$(this).find('input[type="text"], .search-in-dropdown').first();r.length>0&&r.focus();let l=t.data("saved-values"),c=null!=l,i=[];c&&Array.isArray(l)&&(i=l.map(String));const d=["order_price","order_cost","order_quantity","order_discount","order_percent_discount","order_profit","accountant_amount_paid","accountant_owe","accountant_35X43","accountant_polime","accountant_8X10","accountant_10X12","accountant_film_bag"],s=["ord_start_day","accountant_date","accountant_day_payment","accountant_discount_day","accountant_doctor_date_payment"];if(t.data("loaded")){let e=t.find(".filter-checkbox").length,a=t.find(".filter-checkbox:checked").length;return t.find(".filter-checkbox").each(function(){let t=String($(this).val()),e=!c||i.includes(t);$(this).prop("checked",e)}),void(e<=1?(o.prop("disabled",!0).attr("data-locked","true").addClass("btn-secondary").removeClass("btn-primary").html("Apply Filter"),n.prop("disabled",!0).prop("checked",!0),t.find(".filter-checkbox").prop("disabled",!0).prop("checked",!0)):(o.prop("disabled",!1).removeAttr("data-locked").addClass("btn-primary").removeClass("btn-secondary").html("Apply Filter"),n.prop("disabled",!1),t.find(".filter-checkbox").prop("disabled",!1),e>0&&a===e?n.prop("checked",!0):n.prop("checked",!1),toggleApplyButton(t)))}let u={...getValuesFilterObj()};u.hasOwnProperty(e)&&delete u[e],u.field=e,u.year=$(".year-filter").val(),u.type=$(".type-filter").val(),$.ajax({url:url_filter_options,method:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:u,beforeSend:function(){t.html('<div class="text-center text-muted p-2">Loading...</div>')}}).done(function(a){(a=>{let r="",l=!1,u=0,p=0;a.forEach(t=>{let a=t,n=t;null===t||""===t?(n="(Blanks)",a="NULL_EMPTY"):d.includes(e)?n=formatCurrency(t):s.includes(e)?n=formatDate(t):"car_name"===e?n=formatCarName(t):"accountant_status"===e?n=formatAccountantStatus(t):"status_id"===e&&(n=formatOrderStatus(t)),l=!0,u++;let o=String(a),f=!c||i.includes(o);f&&p++,r+=`<label class="dropdown-item-checkbox" style="display:flex; cursor:pointer;">\n                        <input type="checkbox" value="${a}" class="filter-checkbox" ${f?"checked":""}> \n                        ${n}\n                     </label>`}),l||(r='<div class="text-center text-muted p-2">Trống</div>'),t.html(r),t.data("loaded",!0),u<=1?(o.prop("disabled",!0),o.attr("data-locked","true"),o.removeClass("btn-primary btn-info").addClass("btn-secondary"),o.html("Apply Filter"),n.prop("disabled",!0).prop("checked",!0),t.find(".filter-checkbox").prop("disabled",!0),t.find(".filter-checkbox").prop("checked",!0)):(o.prop("disabled",!1),o.removeAttr("data-locked"),o.removeClass("btn-secondary").addClass("btn-primary"),o.html("Apply Filter"),n.prop("disabled",!1),t.find(".filter-checkbox").prop("disabled",!1),u>0&&p===u?n.prop("checked",!0):n.prop("checked",!1),toggleApplyButton(t))})(a)}).fail(function(e){401===e.status||419===e.status?popupNotificationSessionExpired():t.html('<div class="text-danger p-2">Lỗi tải dữ liệu</div>')})}),$(document).on("click",".btn-apply-filter",function(t){t.preventDefault(),t.stopPropagation();try{let t=$(this).closest(".dropdown"),e=t.find(".dropdown-list-container"),a=t.find(".dropdown-toggle");if(0===e.length)return;let n=e.data("field");if("true"===$(this).attr("data-locked"))return void t.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false");let o=t.find("input[type='text']"),r=o.val()&&""!==o.val().trim(),l=e.find(".filter-checkbox").length,c=0,i=[];if(r){let t=e.find(".filter-checkbox:visible:checked");c=t.length,t.each(function(){i.push(String($(this).val()))})}else{let t=e.find(".filter-checkbox:checked");c=t.length,t.each(function(){i.push(String($(this).val()))})}let d=!1;d=0===l||(r?0===c:c===l);let s=e.data("saved-values"),u=!1;if(d)null!=s&&(u=!0);else if(null==s)u=!0;else{JSON.stringify([...s].sort())!==JSON.stringify([...i].sort())&&(u=!0)}if(!u)return void t.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false");let p=getValuesFilterObj();d?(e.removeData("saved-values"),a.find(".selected-text").html('<i class="fa-solid fa-filter"></i>'),a.removeClass("btn-info"),p.hasOwnProperty(n)&&delete p[n]):(e.data("saved-values",i),a.find(".selected-text").html(`(${c}) <span class="caret"></span>`),a.addClass("btn-info"),p[n]=i);let f=$(".dropdown-list-container").not(e);f.removeData("loaded"),f.html('<div class="text-center text-muted p-2">Loading...</div>'),t.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false"),localStorage.setItem("accountant_filter_state",JSON.stringify(p)),$(".tbody-content").empty(),"function"==typeof getListAccountant&&getListAccountant()}catch(t){console.error(t),alert("Lỗi: "+t.message)}}),$(document).on("click",".close-dropdown-btn",function(t){t.preventDefault(),t.stopPropagation();let e=$(this).closest(".dropdown");e.removeClass("show open"),e.find(".dropdown-menu").removeClass("show"),e.find(".dropdown-toggle").attr("aria-expanded","false")}),$(".table-scroll").on("scroll",function(){let t=$(this);t.scrollTop()+t.innerHeight()>=t[0].scrollHeight-20&&nextPageUrl&&!isLoading&&getListAccountant(!0)}),$(document).on("change",".year-filter, .type-filter",function(){saveFilterState(),$(".dropdown-list-container").removeData("loaded"),$(".dropdown-list-container").html('<div class="text-center text-muted p-2">Loading...</div>'),nextPageUrl=url_filter_accountant,$(".tbody-content").empty(),getListAccountant()}),$(document).on("change",".accountant_status",function(){0==$(this).val()?$(this).removeClass("acc-status-paid").addClass("acc-status-unpaid"):($(this).removeClass("acc-status-unpaid").addClass("acc-status-paid"),$(this).closest("tr").removeClass("debt-overrated debt-warning"))});const t=t=>t&&parseFloat(t.replace(/\./g,"").replace(/,/g,""))||0,e=t=>{let e=t.find("input, select").serializeArray();return JSON.stringify(e)};$("tr[data-id]").each(function(){let t=$(this);t.data("original",e(t))});const a=function(t,e){let a;return function(){const n=this,o=arguments;clearTimeout(a),a=setTimeout(()=>t.apply(n,o),e)}}(function(t){let a=t.data("id"),n=e(t),o=t.data("original");if(n===o)return void t.find("input, select").css("border-color","");t.find("input, select").css("border-color","#ffc107");let r=t.find("input, select").serializeArray(),l=localStorage.getItem("accountant_filter_state"),c=[];if(l)try{let t=JSON.parse(l);Object.keys(t).forEach(e=>{c.push({name:e,value:t[e]})})}catch(t){}$.ajax({url:url_update_accountant,method:"PATCH",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{id:a,row_data:r,filter_data:c},success:function(e){e.success?(t.data("original",n),t.find(".status-id").html('<span class="badge badge-primary text-white" style="background-color: #00d0e3">Đã cập nhật doanh thu</span>'),t.find("input, select").css("border-color","#28a745"),setTimeout(()=>t.find("input, select").css("border-color",""),1e3),e.totals&&updateTotalsUI(e.totals),$(".dropdown-list-container").removeData("loaded"),$(".filter-box").removeData("loaded")):t.find("input, select").css("border-color","red")},error:function(e){t.find("input, select").css("border-color","red"),console.log("Lỗi update:",e.responseText)}})},800);$(document).on("input change",".input-accountant, .calc-inputs, .selectbox-accountant",function(){let e=$(this),n=e.closest("tr");if(n.hasClass("row-locked"))return!1;let o=e.attr("name"),r=o;if(o.includes("_")){let t=o.split("_");isNaN(t[t.length-1])||(t.pop(),r=t.join("_"))}!function(e,a){let n=t(e.find(".order_quantity").val()),o=t(e.find(".order_cost").val()),r=t(e.find(".accountant_amount_paid").val()),l=t(e.find(".order_price").val()),c=t(e.find(".order_discount").val()),i=(e.find(".order_vat").val()||"").toLowerCase().trim(),d=0;"order_quantity"===a||"order_cost"===a?(d=n*o,e.find(".order_price").val(formatCurrency(d))):"order_price"===a?d=l:(d=l,0===d&&n*o>0&&(d=n*o,e.find(".order_price").val(formatCurrency(d))));let s=0;if("order_percent_discount"===a||"order_vat"===a||"order_quantity"===a||"order_cost"===a||"order_price"===a){let t=e.find(".order_percent_discount").val()||"",a=t.toLowerCase(),o=t.toString().replace(/\./g,"").replace(/,/g,".");if(a.includes("%")){let t=parseFloat(o.replace("%",""))||0,e=1.1;(i.includes("không")||i.includes("khong"))&&(e=1),s=d/e*(t/100)}else s=a.includes("/ca")?(parseFloat(o.toLowerCase().replace("/ca",""))||0)*n:isNaN(parseFloat(o))||""===o.trim()?0:parseFloat(o);s=Math.round(s),e.find(".order_discount").val(formatCurrency(s))}else s=c;let u=d-s,p=d-r;if(e.find(".order_profit").val(formatCurrency(u)),e.find(".accountant_owe").val(formatCurrency(p)),"accountant_deadline"===a||"accountant_date"===a){let t=parseInt(e.find(".accountant_deadline").val())||0,a=e.find(".accountant_date").val();if(a)try{let n=a.split("/");if(3===n.length){let a=new Date(n[2],n[1]-1,n[0]);a.setDate(a.getDate()+t);let o=("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+a.getFullYear();e.find(".accountant_day_payment").val(o)}}catch(t){}else e.find(".accountant_day_payment").val("")}}(n,r),a(n)}),$(document).on("click",".btn-complete-account",function(t){t.preventDefault();let e=$(this),a=e.data("id");$.ajax({url:url_complete_accountant,method:"PATCH",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{order_id:a},beforeSend:function(){e.prop("disabled",!0).text("Đang xử lý...")},success:function(t){if(t.success){$(".status_id_"+a).html('<span class="badge badge-primary text-white" style="background-color: #007bff">Đã xử lý</span>'),e.hide();let t=e.closest("tr");t.addClass("row-locked"),t.find("input, select").prop("disabled",!0),t.css("background-color","#f8f9fa"),$(".dropdown-list-container").removeData("loaded")}else alert(t.message),e.prop("disabled",!1).text("Hoàn thành")},error:function(t){console.log(t),alert("Có lỗi xảy ra, vui lòng thử lại!"),e.prop("disabled",!1).text("Hoàn thành")}})})});