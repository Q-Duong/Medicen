var typingTimer,doneTypingInterval=600,nextPageUrl=null,isLoading=!1;let originalParent=null,currentMenu=null;const STORAGE_KEY="accountant_filter_state";function formatCurrency(t){return null===t||""===t||isNaN(t)?t:new Intl.NumberFormat("vi-VN").format(t)}const parseNumber=t=>t&&parseInt(t.toString().replace(/\D/g,""))||0,formatInputOnKeyup=t=>{let e=parseNumber(t.val());t.val(new Intl.NumberFormat("vi-VN").format(e))},getRowId=t=>{let e=t.closest("tr").data("id");if(e)return e;let n=t.attr("name");if(n){let t=n.split("_");return t[t.length-1]}return null};function toggleApplyButton(t){let e=t.find(".filter-checkbox:checked").length,n=t.closest(".dropdown-menu").find(".btn-apply-filter");0===e?n.prop("disabled",!0):n.prop("disabled",!1)}function formatDate(t){if(!t)return"";try{let e=t.split("-");return 3===e.length?`${e[2]}/${e[1]}/${e[0]}`:t}catch(e){return t}}function formatCarName(t){if(!t)return"";const e={6:"Xe Thuê",7:"Xe Tăng Cường",8:"Siêu Âm"};return e.hasOwnProperty(t)?e[t]:t}function formatAccountantStatus(t){return 0==t?"Chưa thanh toán":1==t?"Đã thanh toán":t}function formatOrderStatus(t){switch(parseInt(t)){case 0:return'<span class="badge badge-primary text-white" style="background-color: #27c24c">Đơn hàng mới</span>';case 1:return'<span class="badge badge-primary text-white" style="background-color: #FCB322">Đang xử lý</span>';case 2:return'<span class="badge badge-primary text-white" style="background-color: #c037df">Đã cập nhật số Cas thực tế</span>';case 3:return'<span class="badge badge-primary text-white" style="background-color: #007bff">Đã xử lý</span>';case 4:return'<span class="badge badge-primary text-white" style="background-color: #00d0e3">Đã cập nhật doanh thu</span>';default:return'<span class="badge badge-secondary">Chưa xác định</span>'}}function updateDateDisplay(t){let e=$(t).val();if(e){let n=new Date(e);if(!isNaN(n.getTime())){let n=e.split("-"),a=`${n[2]}/${n[1]}/${n[0]}`;$(t).attr("data-date",a)}}else $(t).attr("data-date","")}function getListAccountant(t=!1){if(!nextPageUrl&&t)return;isLoading=!0;let e=$(".tbody-content tr").length,n=getValuesFilterObj();n.current_count=e;let a=t?nextPageUrl:url_get_accountant;$.ajax({url:a,method:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},cache:!1,data:n,beforeSend:function(){}}).done(function(e){t?$(".tbody-content").append(e.html):$(".tbody-content").html(e.html),void 0!==e.totals&&updateTotalsUI(e.totals),nextPageUrl=e.next_page_url,e.html,initForceDateFormat()}).fail(function(t,e,n){popupNotificationSessionExpired()}).complete(function(){isLoading=!1})}function updateTotalsUI(t){$("#total-price").text(formatCurrency(t.totalPrice)),$("#total-owe").text(formatCurrency(t.totalOwe)),$("#total-amount-paid").text(formatCurrency(t.totalAmountPaid)),$("#total-quantity").text(formatCurrency(t.totalQuantity)),$("#total-discount").text(formatCurrency(t.totalDiscount)),$("#total-35").text(t.total35),$("#total-polime").text(t.totalPolime),$("#total-8").text(t.total8),$("#total-10").text(t.total10),$("#total-pack").text(t.totalPack)}function getValuesFilterObj(){let t={};return $(".year-filter, .type-filter").each(function(){t[$(this).attr("name")]=$(this).val()}),$(".dropdown-list-container").each(function(){let e=$(this).data("field"),n=$(this).data("saved-values");n&&Array.isArray(n)&&(t[e]=n)}),t}function saveFilterState(){let t=getValuesFilterObj();localStorage.setItem("accountant_filter_state",JSON.stringify(t))}function restoreFilterState(){let t=localStorage.getItem("accountant_filter_state");if(!t)return;let e=JSON.parse(t);for(const[t,n]of Object.entries(e)){let e=$(`[name="${t}"]`);e.length&&e.val(n);let a=$(`.dropdown-list-container[data-field="${t}"]`);if(a.length&&Array.isArray(n)){a.data("saved-values",n);let t=a.closest(".dropdown").find(".dropdown-toggle");t.find(".selected-text").html(`(${n.length}) <span class="caret"></span>`),t.addClass("btn-info")}}}function getValuesRow(t){return $(`tr[data-id="${t}"]`).find(":input").serializeArray()}function initForceDateFormat(){$(".force-date-format").each(function(){updateDateDisplay(this)})}function successMsg(t){alert(t)}$(document).ready(function(){restoreFilterState(),getListAccountant(),initForceDateFormat(),$(document).on("keyup",".calc-inputs",function(){formatInputOnKeyup($(this))}),$(document).on("click",".excel-dropdown",function(t){t.stopPropagation()}),$(document).on("change",".check-all",function(){let t=$(this).is(":checked"),e=$(this).closest(".dropdown-menu").find(".dropdown-list-container");e.find(".filter-checkbox").prop("checked",t),toggleApplyButton(e)}),$(document).on("change",".filter-checkbox",function(){let t=$(this).closest(".dropdown-list-container"),e=t.find(".filter-checkbox").length,n=t.find(".filter-checkbox:checked").length,a=t.closest(".dropdown-menu").find(".check-all");n===e?a.prop("checked",!0):a.prop("checked",!1),toggleApplyButton(t)}),$(document).on("keyup input",".search-in-dropdown",function(){let t=$(this).val().toLowerCase(),e=$(this).closest(".dropdown-menu"),n=e.find(".dropdown-list-container"),a=e.find(".check-all"),o=a.closest("div, label"),r=n.find(".dropdown-item-checkbox");r.each(function(){let e=$(this).text().toLowerCase();$(this).toggle(e.indexOf(t)>-1)});let l=r.filter(":visible"),i=l.length;if(n.find(".empty-search-msg").remove(),0===i)o.hide(),n.append('<div class="empty-search-msg text-center text-muted p-2">No items match your search.</div>'),a.prop("checked",!1);else{o.show();let t=l.find(".filter-checkbox:checked").length;i>0&&i===t?a.prop("checked",!0):a.prop("checked",!1)}toggleApplyButton(n)}),$(document).on("shown.bs.dropdown",".dropdown",function(){let t=$(this),e=t.find(".excel-dropdown"),n=t.find(".dropdown-toggle");if(0===e.length)return;let a=e.find(".dropdown-list-container"),o=a.data("field"),r=e.find(".check-all"),l=e.find(".btn-apply-filter"),i=t.attr("id");i||(i="dropdown-gen-"+Math.random().toString(36).substr(2,9),t.attr("id",i)),e.attr("data-parent-id",i),originalParent=t,currentMenu=e,$("body").append(e);let c=n[0].getBoundingClientRect(),d=c.bottom,s=c.left;s+300>$(window).width()&&(s=c.right-300);d+400>$(window).height()&&(d=c.top-400),e.css({display:"block",position:"fixed",top:d+"px",left:s+"px","z-index":"9999999",margin:0});let u=e.find('input[type="text"], .search-in-dropdown').first();u.length>0&&setTimeout(function(){u.trigger("focus")},50);let p=a.data("saved-values"),f=null!=p,h=[];f&&Array.isArray(p)&&(h=p.map(String));const g=["order_price","order_cost","order_quantity","order_discount","order_percent_discount","order_profit","accountant_amount_paid","accountant_owe","accountant_35X43","accountant_polime","accountant_8X10","accountant_10X12","accountant_film_bag"],m=["ord_start_day","accountant_date","accountant_day_payment","accountant_discount_day","accountant_doctor_date_payment"];if(a.data("loaded")){let t=a.find(".filter-checkbox").length,e=a.find(".filter-checkbox:checked").length;return a.find(".filter-checkbox").each(function(){let t=String($(this).val()),e=!f||h.includes(t);$(this).prop("checked",e)}),void(t<=1?(l.prop("disabled",!0).attr("data-locked","true").addClass("btn-secondary").removeClass("btn-primary").html("Apply Filter"),r.prop("disabled",!0).prop("checked",!0),a.find(".filter-checkbox").prop("disabled",!0).prop("checked",!0)):(l.prop("disabled",!1).removeAttr("data-locked").addClass("btn-primary").removeClass("btn-secondary").html("Apply Filter"),r.prop("disabled",!1),a.find(".filter-checkbox").prop("disabled",!1),t>0&&e===t?r.prop("checked",!0):r.prop("checked",!1),toggleApplyButton(a)))}let b={...getValuesFilterObj()};b.hasOwnProperty(o)&&delete b[o],b.field=o,b.year=$(".year-filter").val(),b.type=$(".type-filter").val(),$.ajax({url:url_filter_options,method:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:b,beforeSend:function(){a.html('<div class="text-center text-muted p-2">Loading...</div>')}}).done(function(t){(t=>{let e="",n=!1,i=0,c=0;t.forEach(t=>{let a=t,r=t;null===t||""===t?(r="(Blanks)",a="NULL_EMPTY"):g.includes(o)?r=formatCurrency(t):m.includes(o)?r=formatDate(t):"car_name"===o?r=formatCarName(t):"accountant_status"===o?r=formatAccountantStatus(t):"status_id"===o&&(r=formatOrderStatus(t)),n=!0,i++;let l=String(a),d=!f||h.includes(l);d&&c++,e+=`<label class="dropdown-item-checkbox" style="display:flex; cursor:pointer;">\n                        <input type="checkbox" value="${a}" class="filter-checkbox" ${d?"checked":""}> \n                        ${r}\n                     </label>`}),n||(e='<div class="text-center text-muted p-2">Trống</div>'),a.html(e),a.data("loaded",!0),i<=1?(l.prop("disabled",!0),l.attr("data-locked","true"),l.removeClass("btn-primary btn-info").addClass("btn-secondary"),l.html("Apply Filter"),r.prop("disabled",!0).prop("checked",!0),a.find(".filter-checkbox").prop("disabled",!0),a.find(".filter-checkbox").prop("checked",!0)):(l.prop("disabled",!1),l.removeAttr("data-locked"),l.removeClass("btn-secondary").addClass("btn-primary"),l.html("Apply Filter"),r.prop("disabled",!1),a.find(".filter-checkbox").prop("disabled",!1),i>0&&c===i?r.prop("checked",!0):r.prop("checked",!1),toggleApplyButton(a))})(t)}).fail(function(t){401===t.status||419===t.status?popupNotificationSessionExpired():a.html('<div class="text-danger p-2">Lỗi tải dữ liệu</div>')})}),$(".dropdown").on("hidden.bs.dropdown",function(){currentMenu&&originalParent&&(currentMenu.css({display:"",top:"",left:"",position:"","z-index":""}),originalParent.append(currentMenu),currentMenu=null,originalParent=null)}),$(document).on("click",".btn-apply-filter",function(t){t.preventDefault(),t.stopPropagation();try{let t=$(this).closest(".excel-dropdown"),e=t.find(".dropdown-list-container"),n=t.attr("data-parent-id"),a=$("#"+n);0===a.length&&(a=$(this).closest(".dropdown"));let o=a.find(".dropdown-toggle");if(0===e.length)return;let r=e.data("field");if("true"===$(this).attr("data-locked"))return a.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false"),void a.trigger("hidden.bs.dropdown");let l=t.find("input[type='text']"),i=l.val()&&""!==l.val().trim(),c=e.find(".filter-checkbox").length,d=0,s=[];if(i){let t=e.find(".filter-checkbox:visible:checked");d=t.length,t.each(function(){s.push(String($(this).val()))})}else{let t=e.find(".filter-checkbox:checked");d=t.length,t.each(function(){s.push(String($(this).val()))})}let u=!1;u=0===c||(i?0===d:d===c);let p=e.data("saved-values"),f=!1;if(u)null!=p&&(f=!0);else if(null==p)f=!0;else{JSON.stringify([...p].sort())!==JSON.stringify([...s].sort())&&(f=!0)}if(!f)return a.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false"),void a.trigger("hidden.bs.dropdown");let h=getValuesFilterObj();u?(e.removeData("saved-values"),o.find(".selected-text").html('<i class="fa-solid fa-filter"></i>'),o.removeClass("btn-info"),h.hasOwnProperty(r)&&delete h[r]):(e.data("saved-values",s),o.find(".selected-text").html(`(${d}) <span class="caret"></span>`),o.addClass("btn-info"),h[r]=s);let g=$(".dropdown-list-container").not(e);g.removeData("loaded"),g.html('<div class="text-center text-muted p-2">Loading...</div>'),a.removeClass("open show").find(".dropdown-toggle").attr("aria-expanded","false"),a.trigger("hidden.bs.dropdown"),localStorage.setItem("accountant_filter_state",JSON.stringify(h)),$(".tbody-content").empty(),"function"==typeof getListAccountant&&getListAccountant()}catch(t){console.error(t),alert("Lỗi: "+t.message)}}),$(document).on("click",".close-dropdown-btn",function(t){t.preventDefault(),t.stopPropagation();let e=$(this).closest(".excel-dropdown").attr("data-parent-id"),n=$("#"+e);0===n.length&&(n=$(this).closest(".dropdown")),n.removeClass("show open"),n.find(".dropdown-toggle").attr("aria-expanded","false"),n.trigger("hidden.bs.dropdown")});let t,e,n=!1,a=null;$(document).on("mousedown",".draggable-handle",function(o){if(0!==o.button)return;o.preventDefault(),a=$(this).closest(".dropdown-menu"),n=!0;let r=a[0].getBoundingClientRect();t=o.clientX-r.left,e=o.clientY-r.top,a.css({cursor:"move"})}),$(document).on("mousemove",function(o){if(n&&a){let n=o.clientX-t,r=o.clientY-e;a.css({left:n+"px",top:r+"px"})}}),$(document).on("mouseup",function(){n&&a&&(n=!1,a.css({opacity:"1",cursor:"default"}),a=null)}),$(".table-scroll").on("scroll",function(){let t=$(this);t.scrollTop()+t.innerHeight()>=t[0].scrollHeight-20&&nextPageUrl&&!isLoading&&getListAccountant(!0)}),$(document).on("change",".year-filter, .type-filter",function(){saveFilterState(),$(".dropdown-list-container").removeData("loaded"),$(".dropdown-list-container").html('<div class="text-center text-muted p-2">Loading...</div>'),$(".tbody-content").empty(),getListAccountant()}),$(document).on("change",".accountant_status",function(){0==$(this).val()?$(this).removeClass("acc-status-paid").addClass("acc-status-unpaid"):($(this).removeClass("acc-status-unpaid").addClass("acc-status-paid"),$(this).closest("tr").removeClass("debt-overrated debt-warning"))});const o=t=>t&&parseFloat(t.replace(/\./g,"").replace(/,/g,""))||0,r=t=>{let e=t.find("input, select").serializeArray();return JSON.stringify(e)};$("tr[data-id]").each(function(){let t=$(this);t.data("original",r(t))});const l=function(t,e){let n;return function(){const a=this,o=arguments;clearTimeout(n),n=setTimeout(()=>t.apply(a,o),e)}}(function(t){let e=t.data("id"),n=r(t),a=t.data("original");if(n===a)return void t.find("input, select").css("border-color","");t.find("input, select").css("border-color","#ffc107");let o=t.find("input, select").serializeArray(),l=localStorage.getItem("accountant_filter_state"),i=[];if(l)try{let t=JSON.parse(l);Object.keys(t).forEach(e=>{i.push({name:e,value:t[e]})})}catch(t){}$.ajax({url:url_update_accountant,method:"PATCH",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{id:e,row_data:o,filter_data:i},success:function(e){e.success?(t.data("original",n),t.find(".status-id").html('<span class="badge badge-primary text-white" style="background-color: #00d0e3">Đã cập nhật doanh thu</span>'),t.find("input, select").css("border-color","#28a745"),setTimeout(()=>t.find("input, select").css("border-color",""),1e3),e.totals&&updateTotalsUI(e.totals),$(".dropdown-list-container").removeData("loaded"),$(".filter-box").removeData("loaded")):t.find("input, select").css("border-color","red")},error:function(e){t.find("input, select").css("border-color","red"),console.log("Lỗi update:",e.responseText)}})},800);$(document).on("input change",".input-accountant, .calc-inputs, .selectbox-accountant",function(){let t=$(this),e=t.closest("tr");if(e.hasClass("row-locked"))return!1;let n=t.attr("name"),a=n;if(n.includes("_")){let t=n.split("_");isNaN(t[t.length-1])||(t.pop(),a=t.join("_"))}!function(t,e){let n=o(t.find(".order_quantity").val()),a=o(t.find(".order_cost").val()),r=o(t.find(".accountant_amount_paid").val()),l=o(t.find(".order_price").val()),i=o(t.find(".order_discount").val()),c=(t.find(".order_vat").val()||"").toLowerCase().trim(),d=0;"order_quantity"===e||"order_cost"===e?(d=n*a,t.find(".order_price").val(formatCurrency(d))):"order_price"===e?d=l:(d=l,0===d&&n*a>0&&(d=n*a,t.find(".order_price").val(formatCurrency(d))));let s=0;if("order_percent_discount"===e||"order_vat"===e||"order_quantity"===e||"order_cost"===e||"order_price"===e){let e=t.find(".order_percent_discount").val()||"",a=e.toLowerCase(),o=e.toString().replace(/\./g,"").replace(/,/g,".");if(a.includes("%")){let t=parseFloat(o.replace("%",""))||0,e=1.1;(c.includes("không")||c.includes("khong"))&&(e=1),s=d/e*(t/100)}else s=a.includes("/ca")?(parseFloat(o.toLowerCase().replace("/ca",""))||0)*n:isNaN(parseFloat(o))||""===o.trim()?0:parseFloat(o);s=Math.round(s),t.find(".order_discount").val(formatCurrency(s))}else s=i;let u=d-s,p=d-r;if(t.find(".order_profit").val(formatCurrency(u)),t.find(".accountant_owe").val(formatCurrency(p)),"accountant_deadline"===e||"accountant_date"===e){let e=parseInt(t.find(".accountant_deadline").val())||0,n=t.find(".accountant_date").val();if(n)try{let a=n.split("/");if(3===a.length){let n=new Date(a[2],a[1]-1,a[0]);n.setDate(n.getDate()+e);let o=("0"+n.getDate()).slice(-2)+"/"+("0"+(n.getMonth()+1)).slice(-2)+"/"+n.getFullYear();t.find(".accountant_day_payment").val(o)}}catch(t){}else t.find(".accountant_day_payment").val("")}}(e,a),l(e)}),$(document).on("click",".btn-complete-account",function(t){t.preventDefault();let e=$(this),n=e.data("id");$.ajax({url:url_complete_accountant,method:"PATCH",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{order_id:n},beforeSend:function(){e.prop("disabled",!0).text("Đang xử lý...")},success:function(t){if(t.success){$(".status_id_"+n).html('<span class="badge badge-primary text-white" style="background-color: #007bff">Đã xử lý</span>'),e.hide();let t=e.closest("tr");t.addClass("row-locked"),t.find("input, select").prop("disabled",!0),t.css("background-color","#f8f9fa"),$(".dropdown-list-container").removeData("loaded")}else alert(t.message),e.prop("disabled",!1).text("Hoàn thành")},error:function(t){console.log(t),alert("Có lỗi xảy ra, vui lòng thử lại!"),e.prop("disabled",!1).text("Hoàn thành")}})})}),$(document).ready(function(){$(".filter-title").on("click",function(){var t=$(this).closest(".filter-tiles");$(this).next(".tile-content-wrapper").stop().slideToggle(300),t.toggleClass("active")})}),$(document).on("change",".force-date-format",function(){updateDateDisplay(this)});